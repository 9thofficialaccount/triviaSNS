# 🚀 本番環境セットアップガイド

このガイドは、実際の運用に向けた完全なセットアップ手順です。

---

## ステップ1: GitHubにプッシュ

```powershell
cd C:\Users\repka\Downloads\SNS
git push
```

**注意:** 認証が必要な場合は、GitHubのPersonal Access Tokenを使用してください。

---

## ステップ2: Vercelで環境変数を設定

Vercel Dashboard → プロジェクト → **Settings** → **Environment Variables**

### 必須の環境変数

| Key | Value | 説明 |
|-----|-------|------|
| `DATABASE_URL` | `postgres://...` | Prisma Dataベース接続URL |
| `NEXTAUTH_SECRET` | `5RhYr23dtlHvaSgVeX7uqJKZ8CDGIAPE` | セッション暗号化キー |
| `NEXTAUTH_URL` | `https://trivia-sns-xsun.vercel.app` | アプリのURL |

---

## ステップ3: デプロイ

Vercel → **Deployments** → 自動デプロイを待つ（またはRedeployをクリック）

---

## ステップ4: データベースマイグレーション

デプロイ成功後、データベーススキーマを作成：

```powershell
# Vercel CLIをインストール（初回のみ）
npm install -g vercel

# ログイン
vercel login

# プロジェクトにリンク
vercel link

# 本番環境の環境変数を取得
vercel env pull .env.production.local

# マイグレーション実行
npx prisma migrate deploy
```

---

## ステップ5: サンプルデータの削除

⚠️ **重要:** デフォルトのサンプル投稿をすべて削除します。

```powershell
# サンプルデータを削除
npm run db:clean
```

確認を求められたら `yes` と入力してください。

---

## ステップ6: 管理者アカウントの作成

```powershell
# 管理者アカウント作成スクリプトを実行
npm run create-admin
```

以下の情報を入力：
- メールアドレス
- ユーザー名
- 表示名
- パスワード（8文字以上、大文字・小文字・数字を含む）

---

## ステップ7: サイトにアクセス

https://trivia-sns-xsun.vercel.app

### 初回ログイン

作成した管理者アカウントでログインしてください。

---

## 🛡️ セキュリティ機能（実装済み）

### ✅ ユーザー登録のセキュリティ

- **パスワード強度チェック**
  - 8文字以上
  - 大文字・小文字・数字を含む必須
  
- **入力バリデーション**
  - メールアドレス形式チェック
  - ユーザー名：英数字とアンダースコアのみ（3-20文字）
  - SQLインジェクション対策
  - XSS対策（HTMLエスケープ）

- **レート制限**
  - 新規登録：5回/5分
  - 投稿作成：3回/1分

### ✅ 投稿のセキュリティ

- **入力サニタイズ**
  - すべてのテキストをHTMLエスケープ
  - 危険な文字列パターンを検出
  
- **バリデーション**
  - 文字数制限（130字）の厳格チェック
  - URL形式の検証
  - 引用元の必須チェック

### ✅ 管理者機能

- **投稿削除**
  - 不適切な投稿を完全削除
  - Cascade削除で関連データも自動削除
  
- **ファクトチェック**
  - 管理者による警告メモ追加
  - コミュニティノートとして自動承認表示

- **通報管理**
  - 通報の審査・解決・却下
  - 審査メモの記録

---

## 📋 運用チェックリスト

### デプロイ後

- [ ] サイトにアクセスできる
- [ ] ユーザー登録が動作する
- [ ] ログイン/ログアウトが動作する
- [ ] 投稿作成が動作する
- [ ] サンプルデータがすべて削除されている
- [ ] 管理者アカウントが作成されている
- [ ] `/admin` ページにアクセスできる（管理者のみ）

### セキュリティ

- [ ] 環境変数がVercelに正しく設定されている
- [ ] `.env.local` がGitにコミットされていない
- [ ] HTTPSが有効（Vercel自動）
- [ ] 強力なNEXTAUTH_SECRETを使用
- [ ] データベース接続がSSL有効

---

## 🔧 本番運用コマンド

### データベース管理

```powershell
# データベースGUIを開く
DATABASE_URL="your-production-url" npx prisma studio

# サンプルデータをすべて削除
npm run db:clean

# 管理者を追加作成
npm run create-admin
```

### デバッグ

```powershell
# Vercelのログを確認
vercel logs

# ローカルで本番環境をテスト
vercel dev
```

---

## ⚠️ トラブルシューティング

### ユーザー登録がうまくいかない

**考えられる原因:**

1. **データベースマイグレーション未実行**
   ```powershell
   npx prisma migrate deploy
   ```

2. **パスワードが要件を満たしていない**
   - 8文字以上
   - 大文字・小文字・数字を含む
   - 例: `Test1234!`

3. **ユーザー名が無効**
   - 英数字とアンダースコアのみ
   - 3-20文字
   - 例: `user_name_123`

### デプロイエラー

**型エラー:**
- 最新のコードがプッシュされているか確認
- `git push` を再実行

**データベース接続エラー:**
- DATABASE_URLが正しいか確認
- `?sslmode=require` が含まれているか確認

---

## 📊 モニタリング

### 定期的に確認すべきこと

1. **通報の確認**（毎日）
   - `/admin` で通報をチェック
   - 不適切な投稿を削除

2. **データベース使用量**（週1回）
   - Prismaダッシュボードで確認
   - 無料枠: 256MB

3. **Vercel使用量**（月1回）
   - Vercel Dashboard → Usage
   - 帯域幅、ビルド時間を確認

---

## 🎯 本番環境での推奨設定

### パスワードポリシー

現在の要件:
- ✅ 8文字以上
- ✅ 大文字を含む
- ✅ 小文字を含む
- ✅ 数字を含む

### レート制限

現在の設定:
- ✅ 新規登録: 5回/5分
- ✅ 投稿作成: 3回/1分

必要に応じて `lib/security.ts` で調整可能

---

## 🔐 定期的なセキュリティメンテナンス

### 月次

- [ ] `npm audit` でセキュリティ脆弱性をチェック
- [ ] 依存関係を更新
- [ ] 不審なアカウントを確認

### 3ヶ月ごと

- [ ] NEXTAUTH_SECRETを変更（ユーザーは再ログイン必要）
- [ ] データベースのバックアップを確認
- [ ] アクセスログを分析

---

## 📞 サポート

問題が発生した場合：
1. Vercelログを確認
2. `npm run db:studio` でデータベースを確認
3. GitHubでIssueを作成

---

## 🎉 完了！

本番環境の準備が整いました。実際のユーザーを招待して、トリビアSNSを楽しんでください！
